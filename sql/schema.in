/*
** System configuration table
** ex: syntax=sql
*/

CREATE TABLE config
(
	var_name varchar(63) not null,
	var_value varchar(255),
	is_visible integer DEFAULT 1,
	need_server_restart integer DEFAULT 0,
	PRIMARY KEY(var_name)
) TABLE_TYPE;


/*
** Loadable modules
*/

CREATE TABLE modules
(
	module_id integer not null,
	module_name varchar(63),
	exec_name varchar(255),
	module_flags integer not null default 0,
	description SQL_TEXT,
	license_key varchar(255),
	PRIMARY KEY(module_id)
) TABLE_TYPE;


/*
** Users
*/

CREATE TABLE users
(
	id integer not null,
	name varchar(63) not null,
	password varchar(48),
	access integer,
	flags integer,
	full_name varchar(127),
	description varchar(255),
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** User groups
*/

CREATE TABLE user_groups
(
	id integer not null,
	name varchar(63) not null,
	access integer,
	flags integer,
	description varchar(255),
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Users to groups mapping
*/

CREATE TABLE user_group_members
(
	group_id integer not null,
	user_id integer not null,
	PRIMARY KEY(group_id,user_id)
) TABLE_TYPE;


/*
** Nodes to be added
*/

CREATE TABLE new_nodes
(
	id integer not null,
	ip_addr varchar(15) not null,
	ip_netmask varchar(15) not null,
	discovery_flags integer not null
) TABLE_TYPE;


/*
** Nodes information
*/

CREATE TABLE nodes
(
	id integer not null,
	name varchar(63),
	status integer,
	is_deleted integer not null,
	primary_ip varchar(15),
	is_snmp integer,
	is_agent integer,
	is_bridge integer,
	is_router integer,
	is_local_mgmt integer,
	snmp_version integer,
	community varchar(32),
	snmp_oid varchar(255),
	discovery_flags integer,
	auth_method integer,
	secret varchar(64),
	agent_port integer,
	status_poll_type integer,
	image_id integer,
	description SQL_TEXT,
	node_type integer,
	agent_version varchar(63),
	platform_name varchar(63),
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Subnets
*/

CREATE TABLE subnets
(
	id integer not null,
	name varchar(63),
	status integer,
	is_deleted integer not null,
	ip_addr varchar(15),
	ip_netmask varchar(15),
	image_id integer,
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Nodes' interfaces
*/

CREATE TABLE interfaces
(
	id integer not null,
	name varchar(63),
	status integer,
        is_deleted integer,
	node_id integer not null,
	ip_addr varchar(15),
	ip_netmask varchar(15),
	if_type integer,
	if_index integer,
	image_id integer,
	mac_addr varchar(15),
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Network services
*/

CREATE TABLE network_services
(
	id integer not null,
	name varchar(63),
	status integer,
        is_deleted integer,
	node_id integer not null,
	service_type integer,
	ip_bind_addr varchar(15),
	ip_proto integer,
	ip_port integer,
	check_request SQL_TEXT,
	check_responce SQL_TEXT,
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Container objects
*/

CREATE TABLE containers
(
	id integer not null,
	name varchar(63),
	status integer,
	is_deleted integer not null,
	category integer,
	description SQL_TEXT,
	image_id integer,
	object_class integer not null,
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Data collection templates
*/

CREATE TABLE templates
(
	id integer not null,
	name varchar(63),
	is_deleted integer not null,
	image_id integer,
	version integer,
	description SQL_TEXT,
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Mapping hosts to templates
*/

CREATE TABLE dct_node_map
(
	template_id integer not null,
	node_id integer not null,
	PRIMARY KEY(template_id,node_id)
) TABLE_TYPE;


/*
** Nodes to subnets mapping
*/

CREATE TABLE nsmap
(
	subnet_id integer not null,
	node_id integer not null,
	PRIMARY KEY(subnet_id,node_id)
) TABLE_TYPE;


/*
** Container members
*/

CREATE TABLE container_members
(
	container_id integer not null,
	object_id integer not null,
	PRIMARY KEY(container_id,object_id)
) TABLE_TYPE;


/*
** Container categories
*/

CREATE TABLE container_categories
(
	category integer not null,
	name varchar(63),
	image_id integer not null,
	description SQL_TEXT,
	PRIMARY KEY(category)
) TABLE_TYPE;


/*
** Objects' ACLs
*/

CREATE TABLE acl
(
	object_id integer not null,
	user_id integer not null,
	access_rights integer not null,
	PRIMARY KEY(object_id,user_id)
) TABLE_TYPE;


/*
** Objects' access options
*/

CREATE TABLE access_options
(
	object_id integer not null,
	inherit_rights integer not null,
	PRIMARY KEY(object_id)
) TABLE_TYPE;


/*
** Data collection items
**
** If node_id != 0, it's an item bound to node,	and template_id points to 
** the template used for creating this item. In this case, template_id = 0
** means that item was created manually.
** If node_id = 0, it's a template item, and template_id points to a template
** this item belongs to.
** If both node_id and template_id is 0, it's an error.
*/

CREATE TABLE items
(
	item_id integer not null,
	node_id integer not null,	
	template_id integer not null,
	name varchar(255) not null,
	description varchar(255),
	source integer,			// 0 for internal or 1 for native agent or 2 for SNMP
	datatype integer,
	polling_interval integer,
	retention_time integer,
	status integer,			// ACTIVE, DISABLED or NOT_SUPPORTED
	delta_calculation integer,
	transformation SQL_TEXT,	// Transformation formula
	instance varchar(255),		// Free form text which can be used in events
	PRIMARY KEY(item_id)
) TABLE_TYPE;


/*
** Events configuration
*/

CREATE TABLE event_cfg
(
	event_code integer not null,
	event_name varchar(63) not null,	// Short event name
	severity integer,
	flags integer,
	message varchar(255),		// Message template
	description SQL_TEXT,
	PRIMARY KEY(event_code)
) TABLE_TYPE;


/*
** Event log
*/

CREATE TABLE event_log
(
	event_id SQL_INT64 not null,
	event_code integer not null,
	event_timestamp integer,
	event_source integer,			// Source object ID
	event_severity integer,
	event_message varchar(255),
	root_event_id SQL_INT64 default 0,	
		/* Non-zero if current event correlates to some other event */
	PRIMARY KEY(event_id)
) TABLE_TYPE;


/*
** Actions on events
*/

CREATE TABLE actions
(
	action_id integer not null,
	action_name varchar(63) not null,
	action_type integer not null,
	is_disabled integer,
	// Field "rcpt_addr" holds e-mail address for e-mail actions,
	// phone number for sms actions, and remote host address for
	// remote execution actions
	rcpt_addr varchar(255),
	email_subject varchar(255),
	// Field "action_data" holds message text for e-mail and sms actions,
	// command line for external command execution actions, or
	// action name with optional arguments for remote execution actions
	action_data SQL_TEXT not null,
	PRIMARY KEY(action_id)
) TABLE_TYPE;


/*
** Event groups
*/

CREATE TABLE event_groups
(
	id integer not null,
	name varchar(63),
	description varchar(255),
	PRIMARY KEY(id)
) TABLE_TYPE;


/*
** Event group members
*/

CREATE TABLE event_group_members
(
	group_id integer not null,
	event_code integer not null,
	PRIMARY KEY(group_id,event_code)
) TABLE_TYPE;


/*
** Event processing policy
*/

CREATE TABLE event_policy
(
	rule_id integer not null,   // Rule number
	flags integer not null,
	comments SQL_TEXT,
	alarm_message varchar(255),
	alarm_severity integer,
	alarm_key varchar(255),	    // Alarm key (used for auto acknowlegment)
	alarm_ack_key varchar(255), // Acknowlege all alarms with given key
	PRIMARY KEY(rule_id)
) TABLE_TYPE;

CREATE TABLE policy_source_list
(
	rule_id integer not null,
	object_id integer not null,
	PRIMARY KEY(rule_id,object_id)
) TABLE_TYPE;

CREATE TABLE policy_event_list
(
	rule_id integer not null,
	event_code integer not null,
	PRIMARY KEY(rule_id,event_code)
) TABLE_TYPE;

CREATE TABLE policy_action_list
(
	rule_id integer not null,
	action_id integer not null,
	PRIMARY KEY(rule_id,action_id)
) TABLE_TYPE;


/*
** Deleted objects
*/

CREATE TABLE deleted_objects
(
	object_id integer not null,
	object_class integer,
	name varchar(63),
	ip_addr varchar(15),
	ip_netmask varchar(15),
	PRIMARY KEY(object_id)
) TABLE_TYPE;


/*
** Threshold checking rules
*/

CREATE TABLE thresholds
(
	threshold_id integer not null,
	item_id integer not null,
	sequence_number integer not null,
	fire_value varchar(255),
	rearm_value varchar(255),
	check_function integer,
	check_operation integer,
	parameter_1 integer,
	parameter_2 integer,
	event_code integer,
	PRIMARY KEY(threshold_id)
) TABLE_TYPE;


/*
** Alarms
*/

CREATE TABLE alarms
(
	alarm_id integer not null,	// Unique alarm identifier
	alarm_timestamp integer,
	source_object_id integer,
	source_event_code integer,
	source_event_id SQL_INT64,
	message varchar(255),
	severity integer,
	alarm_key varchar(255),	// Alarm key (used for auto acknowlegment)
	is_ack integer,		// TRUE if alarm is acknowleged
	ack_by integer,         // ID of user who acknowleges alarm
	PRIMARY KEY(alarm_id)
) TABLE_TYPE;


/*
** Alarm notes
*/

CREATE TABLE alarm_notes
(
	note_id integer not null,
	alarm_id integer not null,
	alarm_note_timestamp integer,
	note_text SQL_TEXT,
	PRIMARY KEY(note_id)
) TABLE_TYPE;


/*
** Image catalog
*/

CREATE TABLE images
(
	image_id integer not null,
	name varchar(64),
	file_name_png varchar(255),
	file_hash_png varchar(32),
	file_name_ico varchar(255),
	file_hash_ico varchar(32),
	PRIMARY KEY(image_id)
) TABLE_TYPE;


/*
** Default images for various object classes
*/

CREATE TABLE default_images
(
	object_class integer not null,
	image_id integer not null,
	PRIMARY KEY(object_class)
) TABLE_TYPE;


/*
** OID to node type translation
*/

CREATE TABLE oid_to_type
(
	pair_id integer not null,
	snmp_oid varchar(255) not null,
	node_type integer not null,
	node_flags integer not null,
	PRIMARY KEY(pair_id)
) TABLE_TYPE;


/*
** SNMP trap configuration
*/

CREATE TABLE snmp_trap_cfg
(
	trap_id integer not null,
	snmp_oid varchar(255) not null,
	event_code integer not null,
	description varchar(255),
	PRIMARY KEY(trap_id)
) TABLE_TYPE;


/*
** SNMP trap parameters mapping
*/

CREATE TABLE snmp_trap_pmap
(
	trap_id integer not null,
	parameter integer not null,
	snmp_oid varchar(255),
	description varchar(255),
	PRIMARY KEY(trap_id,parameter)
) TABLE_TYPE;


/*
** Agent packages
*/

CREATE TABLE agent_pkg
(
	pkg_id integer not null,
	pkg_name varchar(63),
	version varchar(31),
	platform varchar(63),
	pkg_file varchar(255),
	description varchar(255),
	PRIMARY KEY(pkg_id)	
) TABLE_TYPE;

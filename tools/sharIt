#!/bin/sh

trap '
	rm -f tmp
' INT EXIT

if [ "x"$3 = "x" ]; then
	echo "Usage: $0 input.tar.gz scriptname output.sh"
	exit
fi

[ -r $1 ] || echo "Can't read $1" && exit

md5=`which md5`
if [ $? != 0 ]; then
	md5=`which md5sum`
	if [ $? != 0 ]; then
		md5=`which openssl`
		if [ $? != 0 ]; then
			echo "Can't calculate MD5, exiting"
			exit
		else
			md5="$md5 md5"
		fi
	else
		md5="$md5 | cut -d' ' -f1"
	fi
fi

skip=`echo \`wc -l stub.sh|cut -b1-8\``
sed "s,__SKIP__,$skip,g" < stub.sh | sed "s,__COMMAND__,$2,g" > tmp
hash1=`tail -n+5 tmp | $md5`
hash2=`cat $1 | $md5`
sed "s,__HASH1__,$hash1,g" < tmp | sed "s,__HASH2__,$hash2,g" > $3

cat $1 >> $3
